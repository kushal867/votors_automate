{% extends 'base.html' %}

{% block title %}Intelligence Headquarters | Voter Vision AI{% endblock %}

{% block extra_css %}
<style>
    .strategic-layout {
        display: grid;
        grid-template-columns: 1fr 1.1fr;
        gap: 6rem;
        align-items: center;
        min-height: 80vh;
        padding-top: 2rem;
    }

    @media (max-width: 1200px) {
        .strategic-layout { grid-template-columns: 1fr; gap: 4rem; text-align: center; }
        .hero-image { max-width: 400px; margin: 0 auto; }
        .command-console { height: 600px; }
    }

    @media (max-width: 768px) {
        .strategic-layout { gap: 2.5rem; padding-top: 1rem; }
        .command-console { height: 550px; border-radius: var(--radius-lg); }
        .message-stream { padding: 1.5rem; gap: 1.5rem; }
        .msg-bubble { max-width: 95%; padding: 1rem 1.25rem; font-size: 0.9rem; }
        .console-input-area { padding: 1.25rem; }
        .hero-image { max-width: 280px; }
        h1 { font-size: 2.5rem !important; }
    }

    /* Left Side: Strategic Insight */
    .strategic-brand {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .hero-container {
        position: relative;
        display: inline-block;
    }

    .hero-image {
        width: 100%;
        max-width: 600px;
        filter: drop-shadow(0 0 80px rgba(99, 102, 241, 0.25));
        animation: cinematicFloat 8s ease-in-out infinite;
    }

    @keyframes cinematicFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-25px) rotate(1deg); }
    }

    /* Right Side: Command Console */
    .command-console {
        background: var(--bg-surface);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        height: 750px;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-lg), 0 0 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(40px);
    }

    .console-header {
        padding: 1.5rem 2.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--glass-border);
    }

    .stream-indicator {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .status-pulse {
        width: 10px;
        height: 10px;
        background: var(--secondary);
        border-radius: 50%;
        box-shadow: 0 0 15px var(--secondary);
        animation: pulseGlow 1.5s infinite;
    }

    @keyframes pulseGlow {
        0% { opacity: 0.5; transform: scale(0.9); }
        50% { opacity: 1; transform: scale(1.1); }
        100% { opacity: 0.5; transform: scale(0.9); }
    }

    .message-stream {
        flex: 1;
        overflow-y: auto;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
        scrollbar-width: none;
    }

    .message-stream::-webkit-scrollbar { display: none; }

    .msg-bubble {
        max-width: 85%;
        padding: 1.5rem 2rem;
        font-size: 1rem;
        line-height: 1.7;
        position: relative;
    }

    .msg-user {
        align-self: flex-end;
        background: var(--primary);
        color: white;
        border-radius: 24px 24px 4px 24px;
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.15);
    }

    .msg-ai {
        align-self: flex-start;
        background: var(--glass-white);
        border: 1px solid var(--glass-border);
        color: #e2e8f0;
        border-radius: 24px 24px 24px 4px;
    }

    .console-input-area {
        padding: 2.5rem;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid var(--glass-border);
    }

    .input-box {
        background: rgba(5, 7, 10, 0.8);
        border-radius: 99px;
        padding: 10px 12px 10px 28px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid var(--glass-border);
        transition: all 0.3s;
    }

    .input-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 20px var(--primary-glow);
    }

    .chat-field {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        padding: 12px 0;
        font-size: 1rem;
        outline: none;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .execute-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .execute-btn:hover {
        transform: scale(1.05);
        background: #4f46e5;
        box-shadow: 0 0 20px var(--primary-glow);
    }

    /* AI Response Formatting */
    .source-tag {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 800;
        margin-right: 8px;
        text-transform: uppercase;
    }

    .tag-db { background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); }
    .tag-web { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .tag-ai { background: rgba(244, 63, 94, 0.15); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.3); }
</style>
{% endblock %}

{% block content %}
<div class="strategic-layout reveal">
    <!-- Brand & Strategy -->
    <div class="strategic-brand">
        <div>
            <div class="badge badge-indigo" style="margin-bottom: 1.5rem;">SATELLITE DOWNLINK ACTIVE</div>
            <h1 style="font-size: 4rem;">Intelligence <span class="gradient-text">Headquarters</span></h1>
            <p style="color: var(--text-muted); font-size: 1.25rem; line-height: 1.8; max-width: 500px;">
                Direct interface with the VoterVision AI Core. Execute complex political queries and real-time synthesis across the neural landscape.
            </p>
        </div>
        
        <div class="hero-container">
            <img src="/static/images/nepal_khukuri_map_art.png" class="hero-image" alt="Strategic Intelligence Core">
        </div>
    </div>

    <!-- Interface Console -->
    <div class="command-console">
        <div class="console-header">
            <div class="stream-indicator">
                <div class="status-pulse"></div>
                <span style="font-weight: 800; color: white; letter-spacing: 1px; font-size: 0.9rem; text-transform: uppercase;">Neural Stream</span>
            </div>
            <div class="badge badge-rose" style="font-size: 0.6rem;">Isolated Encryption</div>
        </div>

        <div class="message-stream" id="messageStream">
            <div class="msg-bubble msg-ai">
                <p style="font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.4rem; margin-bottom: 0.8rem;">Systems Initialize</p>
                <p style="opacity: 0.9;">
                    Intelligence nodes synchronized. Ready for political data extraction and strategic profile modeling. 
                    How shall we proceed with the mission parameters?
                </p>
            </div>
        </div>

        <div style="display: none; padding: 0 3rem 1.5rem;" id="typingState">
            <div style="display: flex; align-items: center; gap: 12px; color: var(--primary); font-size: 0.8rem; font-weight: 800; font-family: 'Outfit', sans-serif; letter-spacing: 1px;">
                <div class="status-pulse" style="width: 8px; height: 8px;"></div>
                <span id="typingMessage">SYNTHESIZING INTELLIGENCE...</span>
            </div>
        </div>

        <div class="console-input-area">
            <div class="input-box">
                <input type="text" id="userInput" class="chat-field" placeholder="Input query parameters..." onkeypress="handleKeyPress(event)">
                <button class="execute-btn" onclick="sendMessage()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7-7 7M3 12h18"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const messageStream = document.getElementById('messageStream');
    const userInput = document.getElementById('userInput');
    const typingState = document.getElementById('typingState');

    const statusMessages = [
        "SYNTHESIZING INTELLIGENCE...",
        "ACCESSING SATELLITE NODES...",
        "QUERYING LOCAL DATABASE...",
        "PERFORMING WEB RESEARCH...",
        "ANALYZING POLITICAL RECORD...",
        "FINALIZING DATA PACKET..."
    ];
    let statusInterval;

    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;

        appendUI(query, 'user');
        userInput.value = '';
        
        typingState.style.display = 'block';
        let statusIdx = 0;
        document.getElementById('typingMessage').textContent = statusMessages[statusIdx];
        statusInterval = setInterval(() => {
            statusIdx = (statusIdx + 1) % statusMessages.length;
            document.getElementById('typingMessage').textContent = statusMessages[statusIdx];
        }, 3000);

        messageStream.scrollTop = messageStream.scrollHeight;

        try {
            const response = await fetch("{% url 'chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();
            clearInterval(statusInterval);
            typingState.style.display = 'none';
            
            if (data.status === 'success') {
                appendUI(data.response, 'ai');
            } else {
                appendUI("Interruption: " + data.message, 'ai');
            }
        } catch (error) {
            clearInterval(statusInterval);
            typingState.style.display = 'none';
            appendUI("Satellite Link Failure. Emergency backup link active - please retry.", 'ai');
        }
    }

    function appendUI(text, sender) {
        const div = document.createElement('div');
        div.className = `msg-bubble msg-${sender} reveal`;
        
        if (sender === 'ai') {
            div.innerHTML = formatPacket(text);
        } else {
            div.textContent = text;
        }
        
        messageStream.appendChild(div);
        messageStream.scrollTop = messageStream.scrollHeight;
    }

    function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

    function formatPacket(text) {
        if (!text) return "<em>Empty neural packet received.</em>";
        
        let html = String(text);

        // Advanced Tags
        html = html
            .replace(/\[DB\]/g, '<span class="source-tag tag-db">Database</span>')
            .replace(/\[WEB\]/g, '<span class="source-tag tag-web">Web Node</span>')
            .replace(/\[AI\]/g, '<span class="source-tag tag-ai">Synthetic</span>');

        // Cinematic Typography
        html = html
            .replace(/\*\*(.*?)\*\*/g, '<strong style="color: white; font-weight: 800;">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em style="color: var(--primary); font-weight: 600;">$1</em>');

        // Structure
        html = html
            .replace(/^### (.*$)/gm, '<h3 style="color: white; margin-top: 1.5rem; font-weight: 800; font-family: Outfit;">$1</h3>')
            .replace(/^## (.*$)/gm, '<h2 style="color: white; margin-top: 1.5rem; font-weight: 800; font-family: Outfit;">$1</h2>');

        html = html.replace(/^\- (.*$)/gm, '<li style="margin-left: 20px; margin-top: 0.5rem; opacity: 0.9;">$1</li>');
        html = html.replace(/\n/g, '<br>');

        return html;
    }
</script>
{% endblock %}

