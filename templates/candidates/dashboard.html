{% extends 'base.html' %}

{% block title %}‡§®‡•á‡§™‡§æ‡§≤ ‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§ö‡§® ‡§ñ‡•Å‡§´‡§ø‡§Ø‡§æ | Strategic Dashboard{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Header Summary -->
    <div class="dashboard-header" style="margin-bottom: 3.5rem; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1.5rem;">
        <div>
            <h2 class="traditional-font main-title" style="font-size: 3.2rem; margin-bottom: 0.5rem;">‡§®‡•á‡§™‡§æ‡§≤ ‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§ö‡§® ‡§ñ‡•Å‡§´‡§ø‡§Ø‡§æ</h2>
            <p style="color: var(--text-muted); font-size: 1.15rem; font-weight: 500; letter-spacing: 0.5px;">National Strategic Command Center ‚Äî Real-time Intelligence Synthesis</p>
        </div>
        <div class="dashboard-date" style="text-align: right; color: var(--text-dim); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">
            Sync: {{ stats.last_sync }} <br> 
            Status: <span style="color: var(--accent);">{{ stats.system_status }}</span>
        </div>
    </div>

    <!-- Row 1: High-Fidelity Stat Cards -->
    <div class="stat-grid">
        <div class="glass-card stat-card glow-red">
            <div class="stat-header">
                <div class="stat-icon-box" style="background: rgba(255, 0, 85, 0.1); color: var(--secondary);">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                </div>
                <div class="tiny-sparkline">
                    <svg viewBox="0 0 100 30" width="80" height="25">
                        <path d="M0,25 Q15,5 30,20 T60,10 T100,22" fill="none" stroke="var(--secondary)" stroke-width="2" />
                    </svg>
                </div>
            </div>
            <div class="stat-value">{{ stats.queries_processed }}</div>
            <div class="stat-label">Neural Queries</div>
        </div>

        <div class="glass-card stat-card glow-green">
            <div class="stat-header">
                <div class="stat-icon-box" style="background: rgba(0, 255, 136, 0.1); color: var(--accent);">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <div class="tiny-sparkline">
                    <svg viewBox="0 0 100 30" width="80" height="25">
                        <path d="M0,20 Q20,25 40,5 T70,15 T100,5" fill="none" stroke="var(--accent)" stroke-width="2" />
                    </svg>
                </div>
            </div>
            <div class="stat-value">{{ stats.ingested_data }}</div>
            <div class="stat-label">Data Ingestions</div>
        </div>

        <div class="glass-card stat-card glow-teal">
            <div class="stat-header">
                <div class="stat-icon-box" style="background: rgba(0, 210, 255, 0.1); color: var(--teal);">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9-9c1.657 0 3 4.03 3 9s-1.343 9-3 9m0-18c-1.657 0-3 4.03-3 9s1.343 9 3 9m-9-9a9 9 0 019-9"></path></svg>
                </div>
                <div class="tiny-sparkline">
                    <svg viewBox="0 0 100 30" width="80" height="25">
                        <path d="M0,15 L20,15 L40,25 L60,5 L80,20 L100,10" fill="none" stroke="var(--teal)" stroke-width="2" />
                    </svg>
                </div>
            </div>
            <div class="stat-value">{{ stats.global_reach }}</div>
            <div class="stat-label">Global Pulse</div>
        </div>

        <div class="glass-card stat-card glow-gold">
            <div class="stat-header">
                <div class="stat-icon-box" style="background: rgba(255, 204, 0, 0.1); color: var(--gold);">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <div class="tiny-sparkline">
                    <svg viewBox="0 0 100 30" width="80" height="25">
                        <path d="M0,25 C20,25 40,0 60,15 S80,5 100,5" fill="none" stroke="var(--gold)" stroke-width="2" />
                    </svg>
                </div>
            </div>
            <div class="stat-value">{{ stats.total_assets }}</div>
            <div class="stat-label">Political Assets</div>
        </div>
    </div>

    <!-- Row 2: Maps & Featured Spotlight -->
    <div class="middle-grid">
        <div class="glass-card map-workspace">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 class="box-title">Electoral Distribution Map</h3>
                <div class="map-controls">
                    <span class="active">PROVINCIAL</span>
                    <span>DISTRICT</span>
                </div>
            </div>
            <div class="map-viewport">
                <svg viewBox="0 0 800 450" class="neon-map">
                    <!-- Nepal Outline -->
                    <path d="M50,150 L250,100 L500,80 L780,120 L800,300 L750,380 L550,420 L300,430 L50,380 Z" fill="rgba(67, 97, 238, 0.05)" stroke="var(--primary)" stroke-width="2" />
                    
                    <!-- Province Indicators -->
                    {% for p_code, p_name in provinces %}
                    <g class="map-target" title="{{ p_name }}" onclick="window.location.href='{% url 'candidate-list' %}?province={{ p_code }}'" style="cursor: pointer;">
                        <!-- Use a dynamic pulse if there are candidates in this province -->
                        <circle cx="{% if p_code == '7' %}120{% elif p_code == '6' %}250{% elif p_code == '5' %}350{% elif p_code == '4' %}450{% elif p_code == '3' %}550{% elif p_code == '2' %}650{% else %}720{% endif %}" 
                                cy="{% if p_code == '7' %}220{% elif p_code == '6' %}200{% elif p_code == '5' %}300{% elif p_code == '4' %}180{% elif p_code == '3' %}220{% elif p_code == '2' %}320{% else %}220{% endif %}" 
                                r="8" 
                                fill="var(--primary)" 
                                class="map-node">
                            <animate attributeName="r" values="6;10;6" dur="3s" repeatCount="indefinite" />
                            <animate attributeName="opacity" values="0.4;1;0.4" dur="3s" repeatCount="indefinite" />
                        </circle>
                    </g>
                    {% endfor %}
                    
                    <!-- Scanning Radar Line -->
                    <line x1="0" y1="0" x2="800" y2="0" stroke="var(--accent)" stroke-width="1" opacity="0.3">
                        <animate attributeName="y1" values="0;450;0" dur="8s" repeatCount="indefinite" />
                        <animate attributeName="y2" values="0;450;0" dur="8s" repeatCount="indefinite" />
                    </line>
                </svg>
                <div class="caption-overlay">SENSITIVITY: HIGH / LIVE ASSET HOTSPOTS</div>
            </div>
        </div>

        <div class="glass-card map-workspace">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 class="box-title">Trending Strategic Assets</h3>
                <div class="badge-pill" style="background: rgba(0, 210, 255, 0.1); color: var(--teal);">Real-time</div>
            </div>
            <div class="popular-list" style="display: flex; flex-direction: column; gap: 1rem;">
                {% for cand in popular_candidates %}
                <a href="{% url 'candidate-detail' cand.pk %}" class="popular-item" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px; text-decoration: none; border: 1px solid transparent; transition: 0.3s;">
                    <div style="width: 45px; height: 45px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary);">
                        {% if cand.image %}
                            <img src="{{ cand.image.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #222;">üë§</div>
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <div style="color: #fff; font-weight: 700; font-size: 0.95rem;">{{ cand.name }}</div>
                        <div style="color: var(--text-dim); font-size: 0.75rem;">{{ cand.party }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: var(--secondary); font-weight: 800; font-size: 0.9rem;">{{ cand.view_count }}</div>
                        <div style="color: var(--text-dim); font-size: 0.6rem; text-transform: uppercase;">Views</div>
                    </div>
                </a>
                <style>
                    .popular-item:hover { background: rgba(255,255,255,0.08) !important; border-color: var(--primary) !important; transform: translateX(5px); }
                </style>
                {% empty %}
                <div style="text-align: center; color: var(--text-dim); padding: 2rem;">No engagement data yet.</div>
                {% endfor %}
            </div>
        </div>

        <div class="glass-card spotlight-card">
            <div class="spotlight-header">
                <div class="badge badge-rose" style="border-radius: 8px;">TARGET LOG</div>
                <div class="more-options">...</div>
            </div>
            
            {% if featured_candidate %}
            <div class="target-profile">
                <div class="target-avatar">
                    <div class="scanner-ring"></div>
                    {% if featured_candidate.image %}
                        <img src="{{ featured_candidate.image.url }}" alt="{{ featured_candidate.name }}">
                    {% else %}
                        <div class="avatar-ph">üë§</div>
                    {% endif %}
                </div>
                <h4 style="font-size: 1.8rem; margin-top: 2rem; letter-spacing: -0.5px;">{{ featured_candidate.name }}</h4>
                <div style="color: var(--secondary); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px;">{{ featured_candidate.party }}</div>
                
                <div class="target-metrics">
                    <div class="metric">
                        <span class="m-val">{{ stats.ingested_data }}</span>
                        <span class="m-lab">Files</span>
                    </div>
                    <div class="metric highlight">
                        <span class="m-val">{{ featured_candidate.view_count|default:0 }}</span>
                        <span class="m-lab">Signals</span>
                    </div>
                    <div class="metric">
                        <span class="m-val">{{ featured_candidate.search_count|default:0 }}</span>
                        <span class="m-lab">Drill</span>
                    </div>
                </div>

                <div style="margin-top: 2.5rem; text-align: left;">
                    <div class="box-title" style="font-size: 0.65rem; margin-bottom: 1rem;">Neural Hotspots (Trending)</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.6rem;">
                        {% for topic in trending_topics %}
                            <a href="{% url 'global-search' %}?q={{ topic }}" class="badge-pill" style="background: rgba(255, 204, 0, 0.05); color: var(--gold); font-size: 0.7rem; border: 1px solid rgba(255, 204, 0, 0.2); padding: 4px 12px; text-decoration: none; transition: 0.3s; display: inline-block;">#{{ topic }}</a>
                        {% empty %}
                            <span style="color: var(--text-dim); font-size: 0.7rem;">Monitoring network...</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-dim);">No Active Target Loaded</div>
            {% endif %}
        </div>
    </div>

    <!-- Row 3: Analytics & Records -->
    <div class="bottom-grid">
        <div class="glass-card analytic-box">
            <h3 class="box-title">Network Sentiment Velocity</h3>
            <div class="chart-container" style="height: 200px; margin-top: 2rem;">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <div class="glass-card analytic-box">
             <h3 class="box-title">Intelligence Flow Index</h3>
             <div class="chart-container" style="height: 200px; margin-top: 2rem;">
                  <canvas id="flowChart"></canvas>
             </div>
        </div>

        <div class="glass-card profile-feed">
            <h3 class="box-title">System Activity Flow</h3>
            <div class="feed-container">
                {% for activity in activities %}
                <div class="feed-entry">
                    <div class="entry-avatar">
                        {{ activity.icon }}
                    </div>
                    <div class="entry-meta">
                        <div class="e-name">{{ activity.type }}</div>
                        <div class="e-sub">{{ activity.detail }}</div>
                    </div>
                    <div class="e-tag status-norm">{{ activity.time|timesince }} ago</div>
                </div>
                {% empty %}
                <div style="padding: 2rem; text-align: center; color: var(--text-dim);">No recent activity detected.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Row 4: Strategic Intelligence Briefing -->
    <div style="margin-top: 3.5rem;">
        <div class="section-label">Strategic Intelligence Briefing [Real-time]</div>
        <div class="stat-grid" style="grid-template-columns: repeat(3, 1fr);">
            {% for news in news_briefing %}
            <div class="glass-card premium-card" style="padding: 2rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <div class="badge badge-emerald">INTELLIGENCE</div>
                    <div style="color: var(--text-dim); font-size: 0.65rem; font-weight: 800;">{{ news.time }}</div>
                </div>
                <h4 style="font-size: 1.1rem; margin-bottom: 1rem; color: #fff;">{{ news.title }}</h4>
                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">{{ news.snippet }}</p>
                <div style="margin-top: 2rem; display: flex; align-items: center; gap: 10px; color: var(--primary); font-size: 0.75rem; font-weight: 800; cursor: pointer;">
                    ANALYZE SIGNAL <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7-7 7M3 12h18"></path></svg>
                </div>
            </div>
            {% empty %}
            <div class="glass-card" style="grid-column: span 3; text-align: center; color: var(--text-dim); padding: 3rem;">
                Scanning for real-time political signals...
            </div>
            {% endfor %}
        </div>
    </div>
        <!-- Row 4: Strategic Intelligence Terminal -->
    <div class="glass-card terminal-box" style="margin-top: 2.2rem; background: #000; border: 1px solid var(--primary); padding: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="status-dot" style="background: var(--accent); box-shadow: 0 0 10px var(--accent);"></div>
                <h3 class="box-title" style="color: var(--primary);">System Intelligence Terminal [v4.0]</h3>
            </div>
            <div style="font-family: monospace; font-size: 0.7rem; color: var(--text-dim);">ENCRYPTED_LINK: ACTIVE</div>
        </div>
        <div class="terminal-content" id="systemTerminal" style="font-family: 'Courier New', monospace; font-size: 0.8rem; color: var(--accent); height: 150px; overflow-y: auto; padding-right: 1rem;">
            <div class="terminal-line" style="color: var(--text-dim); margin-bottom: 5px;">[SYSTEM_STARTUP] INITIALIZING NEURAL PATHWAYS...</div>
            <div class="terminal-line" style="color: var(--primary); margin-bottom: 5px;">[LINK_ESTABLISHED] VVN-CORE v4.0.2 SECURE CONNECTION</div>
            {% for activity in activities %}
            <div class="terminal-line" style="margin-bottom: 5px; border-left: 2px solid var(--primary); padding-left: 10px; opacity: 0.8;">
                <span style="color: var(--text-dim);">[{{ activity.time|date:"H:i:s" }}]</span> 
                <span style="color: var(--primary);">SIGNAL_DETECTED:</span> 
                {{ activity.type|upper }} -> {{ activity.detail }}
            </div>
            {% endfor %}
            <div id="terminalBottom"></div>
            <div class="terminal-cursor" style="display: inline-block; width: 8px; height: 15px; background: var(--accent); animation: blink 1s infinite;"></div>
        </div>
    </div>
</div>

<style>
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .terminal-content::-webkit-scrollbar { width: 4px; }
    .terminal-content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
    .terminal-box { position: relative; overflow: hidden; }
    .terminal-box::after { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 1px, transparent 1px, transparent 2px); pointer-events: none; }
    .dashboard-wrapper { padding-bottom: 5rem; }

    /* Grids */
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2.2rem; margin-bottom: 3.5rem; }
    .middle-grid { display: grid; grid-template-columns: 1fr 1fr 400px; gap: 2.2rem; margin-bottom: 3.5rem; }
    .bottom-grid { display: grid; grid-template-columns: 1fr 1fr 400px; gap: 2.2rem; }

    @media (max-width: 1400px) {
        .middle-grid, .bottom-grid { grid-template-columns: 1fr 1fr; }
        .spotlight-card, .profile-feed { grid-column: span 2; }
    }

    @media (max-width: 1024px) {
        .stat-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
        .stat-grid { grid-template-columns: 1fr; gap: 1.5rem; }
        .middle-grid, .bottom-grid { grid-template-columns: 1fr; gap: 1.5rem; }
        .spotlight-card, .profile-feed { grid-column: span 1; }
        .main-title { font-size: 2.2rem !important; }
        .dashboard-header { flex-direction: column; align-items: flex-start !important; }
        .dashboard-date { text-align: left !important; }
    }

    /* Components */
    .box-title {
        font-size: 0.85rem;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 800;
    }

    .stat-card {
        padding: 2.2rem;
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-lg);
    }

    .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
    .stat-icon-box { width: 54px; height: 54px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
    .stat-value { font-size: 2.4rem; font-weight: 800; color: #fff; margin-bottom: 0.4rem; font-family: 'Outfit'; }
    .stat-label { font-size: 0.8rem; color: var(--text-dim); font-weight: 700; text-transform: uppercase; }

    /* Maps */
    .map-workspace { height: 420px; display: flex; flex-direction: column; }
    .map-viewport { flex: 1; background: rgba(0,0,0,0.3); border-radius: var(--radius-md); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass-border); }
    .neon-map { width: 100%; height: 90%; }
    .caption-overlay { position: absolute; bottom: 1.5rem; left: 1.5rem; font-size: 0.65rem; color: var(--primary); font-weight: 900; letter-spacing: 2px; opacity: 0.7; }
    
    .map-controls { display: flex; gap: 1rem; }
    .map-controls span { font-size: 0.65rem; font-weight: 900; color: var(--text-dim); cursor: pointer; padding-bottom: 4px; border-bottom: 2px solid transparent; }
    .map-controls span.active { color: var(--primary); border-color: var(--primary); }

    /* Spotlight */
    .spotlight-card { background: linear-gradient(135deg, var(--bg-surface) 0%, #151b2d 100%); padding: 3rem; text-align: center; }
    .target-avatar { position: relative; width: 160px; height: 160px; margin: 0 auto; padding: 10px; }
    .target-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; filter: contrast(1.1) saturate(1.2); }
    .scanner-ring { position: absolute; inset: 0; border: 2px solid var(--secondary); border-radius: 50%; border-top-color: transparent; border-bottom-color: transparent; animation: rotate 3s linear infinite; }
    
    .target-metrics { display: flex; justify-content: space-around; margin-top: 3.5rem; padding-top: 2.5rem; border-top: 1px solid var(--glass-border); }
    .metric { display: flex; flex-direction: column; gap: 5px; }
    .m-val { font-size: 1.4rem; font-weight: 800; color: #fff; }
    .m-lab { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
    .metric.highlight .m-val { color: var(--secondary); text-shadow: 0 0 10px rgba(255, 0, 85, 0.4); }

    /* Analytics */
    .analytic-box { padding: 2.5rem; }
    .bar-ensemble { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; margin-top: 2rem; }
    .bar-wrapper { display: flex; flex-direction: column; align-items: center; gap: 1rem; flex: 1; }
    .bar { width: 30px; border-radius: 8px 8px 2px 2px; background: var(--c); box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .bar:hover { filter: brightness(1.3); transform: scaleY(1.05); }
    .bar-wrapper span { font-size: 0.65rem; color: var(--text-dim); font-weight: 800; }

    .vector-graph { height: 180px; margin-top: 2rem; }

    /* Feed */
    .feed-container { display: flex; flex-direction: column; gap: 1.5rem; margin-top: 2rem; }
    .feed-entry { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); padding: 1.2rem; border-radius: 14px; border: 1px solid var(--glass-border); transition: 0.3s; }
    .feed-entry:hover { background: rgba(255,255,255,0.06); transform: scale(1.02); }
    .entry-avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--bg-surface); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--glass-border); }
    .entry-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .entry-meta { flex: 1; }
    .e-name { font-size: 0.95rem; font-weight: 800; color: #fff; }
    .e-sub { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; }
    .e-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 900; }
    .status-high { background: rgba(0, 255, 136, 0.1); color: var(--accent); }
    .status-norm { background: rgba(255, 255, 255, 0.05); color: var(--text-dim); }

    /* Animations */
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes flowing { 0% { stroke-dashoffset: 100; } 100% { stroke-dashoffset: 0; } }
    .flowing-path { animation: flowing 5s linear infinite; }
    @keyframes ping { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
    .ping { animation: ping 2s infinite ease-out; transform-origin: center; }
    @keyframes glow { 0%, 100% { opacity: 0.5; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
    .glow-pulse { animation: glow 2s infinite ease-in-out; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Theme colors
    const colors = {
        primary: '#4361ee',
        secondary: '#ff0055',
        accent: '#00ff88',
        gold: '#ffcc00',
        teal: '#00d2ff',
        text: '#94a3b8'
    };

    // Sentiment Chart
    const ctxSentiment = document.getElementById('sentimentChart').getContext('2d');
    new Chart(ctxSentiment, {
        type: 'bar',
        data: {
            labels: ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN'],
            datasets: [{
                label: 'Sentiment Score',
                data: {{ sentiment_data|safe }},
                backgroundColor: [
                    colors.secondary, colors.primary, colors.accent,
                    colors.gold, colors.teal, colors.primary
                ],
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false, beginAtZero: true, max: 100 },
                x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 10, weight: 'bold' } } }
            }
        }
    });

    // Flow Chart
    const ctxFlow = document.getElementById('flowChart').getContext('2d');
    const gradient = ctxFlow.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(67, 97, 238, 0.4)');
    gradient.addColorStop(1, 'rgba(67, 97, 238, 0)');

    new Chart(ctxFlow, {
        type: 'line',
        data: {
            labels: ['24h ago', '20h ago', '16h ago', '12h ago', '8h ago', '4h ago', 'Now'],
            datasets: [{
                label: 'Flow Index',
                data: {{ flow_data|safe }},
                borderColor: colors.primary,
                borderWidth: 3,
                fill: true,
                backgroundColor: gradient,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: colors.primary,
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false, beginAtZero: true },
                x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 10, weight: 'bold' } } }
            }
        }
    });

    // Auto-scroll terminal to bottom
    const terminal = document.getElementById('systemTerminal');
    if (terminal) {
        terminal.scrollTop = terminal.scrollHeight;
        
        // Add random fake lines periodically to keep it "alive"
        const fakeLogs = [
            "BUFFERING_SATELLITE_LINK...",
            "DECRYPTING_POLITICAL_SIGNAL...",
            "VOICE_ENCODING_VERIFIED",
            "CROSS_REFERENCING_DATABASE...",
            "NEURAL_MAP_RECALIBRATED"
        ];
        
        setInterval(() => {
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.style.cssText = 'margin-bottom: 5px; color: var(--text-dim); opacity: 0.6;';
            const now = new Date();
            line.innerHTML = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}] <span style="color: var(--teal);">INFO:</span> ${fakeLogs[Math.floor(Math.random() * fakeLogs.length)]}`;
            terminal.insertBefore(line, document.getElementById('terminalBottom'));
            terminal.scrollTop = terminal.scrollHeight;
        }, 8000);
    }

    // Simple counter animation
    document.querySelectorAll('.stat-value').forEach(el => {
        const rawValue = el.innerText.replace('+', '').replace(/[^\d]/g, '');
        const target = parseInt(rawValue);
        if (isNaN(target)) return;
        
        let current = 0;
        const duration = 2000;
        const steps = 60;
        const stepValue = target / steps;
        
        const counter = setInterval(() => {
            current += stepValue;
            if (current >= target) {
                el.innerText = (el.innerText.includes('+') ? target + '+' : target);
                clearInterval(counter);
            } else {
                el.innerText = (el.innerText.includes('+') ? Math.floor(current) + '+' : Math.floor(current));
            }
        }, duration / steps);
    });
</script>
{% endblock %}
